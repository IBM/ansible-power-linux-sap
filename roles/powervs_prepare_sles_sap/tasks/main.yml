---
### this role preconfigures LPAR for SAP installation requirement. Based on sap_solution input, saptune configures the system for HANA or NETWEAVER.

# subscribing to SUSE subscription
# Add repos for installing SLES packages required for SAP installation
- name: Register SUSE and enable repos
  shell: |
   SUSEConnect -r {{ suse_subscription.key }}  -e {{ suse_subscription.username }}
   SUSEConnect -p sle-module-public-cloud/{{suse_subscription.release}}/ppc64le
  when: suse_subscription is defined

# making sure all requisite filesets are installed. 
- name: Checking for multipath package
  package:
   name: multipath-tools
   state: present

# multipathd daemon is checked whether it's up or not. If not, it is started. 
- name: Ensure multipathd daemon is running
  service:
   name: multipathd
   state: started 
   enabled: yes

# For modification on network interfaces, create a dictionary of interfaces
- name: Create interfaces dictionary
  set_fact:
   interfaces: "{{ interfaces | default({}) | combine( {item: hostvars[ inventory_hostname ] ['ansible_' + item ]} ) }}"
  with_items: "{{ ansible_interfaces | replace('-', '_') }}"

# to make the above changes persistent across reboot.
- name: Set jumbo frames permanently so it is valid after reboots for all networks except eth0 and lo
  lineinfile:
   dest: "/etc/sysconfig/network/ifcfg-{{ item.key }}"
   regexp: "^MTU"
   line: "MTU='9000'"
  with_dict: "{{ interfaces }}"
  when:
  - "item.value.ipv4.address is defined"
  - "host_ip is not defined or item.value.ipv4.address != host_ip"
  - "item.key != 'lo'"
  - "item.value.mtu != 9000"

# to set jumbo frame changes persistent across reboot.
- name: Set ETHTOOL_OPTIONS TSO ON permanently so it is valid after reboot for all networks except eth0 and lo
  lineinfile:
   dest: "/etc/sysconfig/network/ifcfg-{{ item.key }}"
   regexp: "^ETHTOOL_OPTIONS"
   line: "ETHTOOL_OPTIONS='-K {{ item.key }} tso on'"
  with_dict: "{{ interfaces }}"
  when:
  - "item.value.ipv4.address is defined"
  - "host_ip is not defined or item.value.ipv4.address != host_ip"
  - "item.key != 'lo'"

# to reinforce changes in current boot 
- name: Restart network 
  service:
    name: network 
    state: restarted

# following task checked for SAPTUNE profile on system and apply {{ sap_solution }} profile if not applied. Also check for saptune rpm installation
- name: Check saptune package installation
  zypper:
    name: saptune
    state: present

- name: Check if {{ sap_solution | upper }} solution is applied or not 
  shell: "saptune solution enabled | grep -xi {{ sap_solution }}"
  register: saptune_status
  ignore_errors: true

# Revert is any other solution is already applied, and apply {{ sap_solution | upper }} 
- name: Tune SLES for SAP {{ sap_solution | upper }}
  shell: |
         saptune revert all
         saptune solution apply {{ sap_solution | upper }}
         saptune service enablestart
  when: saptune_status.rc != 0 

- name: Activate SLES tuning for SAP {{ sap_solution | upper }}
  shell: "saptune service takeover"

- name: Check for saptune installation and enablement
  shell: saptune_check
  register: saptune_check_log
  ignore_errors: true

# Fail if saptune is not setup correctly
- debug:
   msg: "Saptune may not be setup correctly, please verify and perform corrective action"
  when: saptune_check_log.rc != 0

# Installing irqbalance package
- name: Installing irqbalance package
  package:
   name: irqbalance
   state: present

- name: Enabling and starting irqbalance
  service:
   name: irqbalance.service
   state: restarted
   enabled: yes

# to Ensure that NFS and rpcbind daemon are up. 
- name: Ensure NFS client is running
  service:
   name: nfs
   state: started
   enabled: yes

- name: Ensure rpcbind is running
  service:
   name: rpcbind
   state: started
   enabled: yes
