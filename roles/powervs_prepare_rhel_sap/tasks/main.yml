# ----------------------------------------------------------------------
# Copyright 2021, 2022 IBM Corp. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ------------------------------------------------------------------------
---
# this role configures RHEL lpar for sap installation.

# Setting up proxy based on private_proxy_ip_port. If this variable is defined, proxy will be added to /etc/bashrc file.
- name: Setting up a proxy
  when: private_proxy_ip_port is defined
  block:
    - name: Edit /etc/bashrc file, to add http_proxy
      ansible.builtin.blockinfile:
        path: /etc/bashrc
        block: |
          http_proxy=http://{{ private_proxy_ip_port }}
          https_proxy=http://{{ private_proxy_ip_port }}
          HTTP_PROXY=http://{{ private_proxy_ip_port }}
          HTTPS_PROXY=http://{{ private_proxy_ip_port }}
    - name: Edit /etc/dnf/dnf.conf to add proxy
      ansible.builtin.blockinfile:
        path: /etc/dnf/dnf.conf
        block: |
          proxy=http://{{ private_proxy_ip_port }}

# Subscribing to Full LinuxÂ® subscription for Power Systems Virtual Servers
- name: Setting up subscription and registration for the RHEL OS to configure the LPAR
  when:
    - full_linux_subscription | default(False) | bool
    - private_proxy_ip_port is defined
  block:
    # Creating backup of readme file, to be restored later
    - name: Copy /usr/share/powervs-fls/powervs-fls-readme.md file
      ansible.builtin.copy:
        src: /usr/share/powervs-fls/powervs-fls-readme.md
        dest: /usr/share/powervs-fls/powervs-fls-readme.md_copy
        mode: "0600"

    # Modifying readme file, to update proxy server and port
    - name: Update cloud-init command with proxy server details
      ansible.builtin.replace:
        path: /usr/share/powervs-fls/powervs-fls-readme.md
        regexp: Private.proxy.IP.address:3128
        replace: "{{ private_proxy_ip_port }}"

    # Get the cloud-init command from readme
    - name: Get the cloud-init command from /usr/share/powervs-fls/powervs-fls-readme.md
      ansible.builtin.command: grep {{ private_proxy_ip_port }} /usr/share/powervs-fls/powervs-fls-readme.md
      register: cloud_init_command

    # Backing up the log file and removing it for latest use
    - name: Backup the powervs-fls.log file
      ansible.builtin.copy:
        src: /var/log/powervs-fls.log
        dest: /var/log/powervs-fls.log.backup
        mode: "0600"
      ignore_errors: true
    - name: Remove the powervs-fls.log file
      ansible.builtin.file:
        path: /var/log/powervs-fls.log
        state: absent

    - name: Execute cloud-init command
      ansible.builtin.command: "{{ cloud_init_command.stdout }}"

    - name: Wait until the string "Exiting RHEL subscription registration process" is in the file /var/log/powervs-fls.log before continuing
      ansible.builtin.wait_for:
        path: /var/log/powervs-fls.log
        search_regex: "Exiting RHEL subscription registration process"
      ignore_errors: true
      register: check_for_subscription_success

    - name: Getting RedHat registering server name
      ansible.builtin.shell: grep sap_hana /usr/share/powervs-fls/powervs-fls-readme.md | awk -F"\-u" '{ print $NF }' | awk '{ print $1 }'
      register: rhsm_host

    # Check for successful Registration
    - name: Check for successful registration
      ansible.builtin.shell: subscription-manager config | grep {{ rhsm_host.stdout }}
      register: check_with_subscription_manager
      ignore_errors: true

    # Restoring Readme
    - name: Restoring /usr/share/powervs-fls/powervs-fls-readme.md file
      ansible.builtin.copy:
        src: /usr/share/powervs-fls/powervs-fls-readme.md_copy
        dest: /usr/share/powervs-fls/powervs-fls-readme.md
        mode: "0600"

    - name: Delete the file /usr/share/powervs-fls/powervs-fls-readme.md_copy
      ansible.builtin.file:
        path: /usr/share/powervs-fls/powervs-fls-readme.md_copy
        state: absent

    # Fail if registration fails.
    - name: Check if the subscription was successful
      ansible.builtin.fail:
        msg: "Full Linux Subscription failed, Please debug manually and take corrective action. Logs available at /var/log/powervs-fls.log"
      when:
        - check_with_subscription_manager.rc != 0 or check_for_subscription_success.failed | bool

## END of cloud-init block.

# Subscribing to RHEL and setting release to {{ rhel_subscription.release }}
- name: Subscribing RHEL and setting release
  when: rhel_subscription is defined
  block:
    - name: Subscribing to RHEL and setting release to {{ rhel_subscription.release }}
      community.general.redhat_subscription:
        state: present
        username: "{{ rhel_subscription.username }}"
        password: "{{ rhel_subscription.password }}"
        release: "{{ rhel_subscription.release }}"
        auto_attach: true
        force_register: true

    # setting fact for major release. This will be used to setup repos for particular release.
    - name: Set up the variable for the major release that will be used to setup repos
      ansible.builtin.set_fact:
        rhel_major_release: "{{ rhel_subscription.release | int }}"

    # Add repos for installing RHEL packages required for SAP installation
    - name: Adding RHEL repos
      community.general.rhsm_repository:
        name: "{{ item }}"
        state: enabled
      with_items:
        - rhel-{{ rhel_major_release }}-for-ppc64le-baseos-e4s-rpms
        - rhel-{{ rhel_major_release }}-for-ppc64le-appstream-e4s-rpms
        - rhel-{{ rhel_major_release }}-for-ppc64le-sap-solutions-e4s-rpms
        - rhel-{{ rhel_major_release }}-for-ppc64le-sap-netweaver-e4s-rpms
        - rhel-{{ rhel_major_release }}-for-ppc64le-highavailability-e4s-rpms

# END of rhel_subscription block

# making sure all requisite filesets are installed.
- name: Checking for multipath package
  ansible.builtin.package:
    name: device-mapper-multipath
    state: present

# multipathd daemon is checked whether it's up or not. If not, it is started.
- name: Ensure multipathd daemon is running
  ansible.builtin.service:
    name: multipathd
    state: started
    enabled: true

# For modification on network interfaces, create a dictionary of interfaces
- name: Create interfaces dictionary
  ansible.builtin.set_fact:
    interfaces: "{{ interfaces | default({}) | combine( { item: hostvars[ inventory_hostname ] ['ansible_' + item ]} ) }}"
  with_items: "{{ ansible_interfaces | replace('-', '_') }}"

# to make jumbo frame persistent across reboot.
- name: Set jumbo frames permanently so it is valid after reboots for all networks except eth0 and lo
  ansible.builtin.lineinfile:
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ item.key }}"
    regexp: "^MTU"
    line: "MTU='9000'"
  with_dict: "{{ interfaces }}"
  when:
    - "item.value.ipv4.address is defined"
    - "host_ip is not defined or item.value.ipv4.address != host_ip"
    - "item.key != 'lo'"
    - "item.value.mtu != 9000"

# to reinforce changes in current boot
- name: Restart network
  ansible.builtin.service:
    name: NetworkManager
    state: restarted
  changed_when: false
# Installing irqbalance package
- name: Installing irqbalance package
  ansible.builtin.package:
    name: irqbalance
    state: present

- name: Enabling and starting irqbalance
  ansible.builtin.service:
    name: irqbalance.service
    state: restarted
    enabled: true
  changed_when: false
# to Ensure that NFS and rpcbind daemon are up.
- name: Ensure NFS client is running
  ansible.builtin.service:
    name: nfs-client.target
    state: started
    enabled: true

- name: Ensure rpcbind is running
  ansible.builtin.service:
    name: rpcbind
    state: started
    enabled: true

# To ensure transparent_hugepage is set to never
- name: Set transparent_hugepage to never
  ansible.builtin.shell: echo never > /sys/kernel/mm/transparent_hugepage/enabled
  changed_when: false
