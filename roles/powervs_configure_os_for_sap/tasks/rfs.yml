---
# Ensure RFS configuration persists

- name: Persist rps_sock_flow_entries in sysctl.conf
  ansible.builtin.lineinfile:
    path: /etc/sysctl.conf
    regexp: "^net.core.rps_sock_flow_entries"
    line: "net.core.rps_sock_flow_entries=32768"
    state: present

- name: Reload sysctl configuration
  ansible.builtin.shell: sysctl -p
  register: sysctl_reload
  changed_when: "'net.core.rps_sock_flow_entries' in sysctl_reload.stdout"

- name: Ensure custom systemd unit for RFS configuration exists
  ansible.builtin.copy:
    dest: /etc/systemd/system/rfs-config.service
    content: |
      [Unit]
      Description=Set RPS flow control settings
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c "sleep 5; for file in $(find /sys/class/net/*/queues/ -name 'rx-*' | grep -v '/lo/'); do echo 32768 > $file/rps_flow_cnt; done"

      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: "0644"

- name: Reload systemd manager
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable and start RFS configuration service
  ansible.builtin.systemd:
    name: rfs-config.service
    enabled: true
    state: restarted
